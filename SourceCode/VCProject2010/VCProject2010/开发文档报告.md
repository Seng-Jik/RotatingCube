~~~
开发文档报告要采用Word或者PDF格式。文档的页眉必须设置为“第十六届山东省大
学生软件设计大赛参赛作品报告”；
报告还应包含以下内容：
i.	游戏简介以及创意
ii.	游戏操作以及闯关关键点
iii.	游戏整体框架
iv.	代码结构
v.	关键技术点
vi.	完成时间进度情况
vii.	参考他人作品
viii.	小组成员以及分工

~~~

# 旋转魔方 开发文档报告

## 一、游戏简介以及创意



## 二、游戏操作以及闯关关键点

使用鼠标操作，按住鼠标左键并移动鼠标即可旋转方块。
将方块旋转到和黑色图形重合即可过关。

## 三、游戏整体框架

* FunCode引擎增强
  + 在C\+\+14上使用的C\+\+17特性
    - optional数据结构
  + 图形增强
    - 3D模型的加载、渲染、存放
    - 后处理
    - 着色器
    - 2D增强
    - 纹理
  + 复写表数据结构
  + 资源管理增强
  + GPU资源管理器
  + 数学工具
  + 任务表
  + 补帧器
  + 基本游戏对象
    - 按钮
    - 鼠标光标
    - 游戏对象集合
* 游戏逻辑
  + 用于测试FunCode引擎及FunCode增强部分的测试单元
  + 游戏玩法逻辑
    - 答案板
    - 时间显示器
    - 关卡入口点
    - 解密方块
    - 通关对话框
    - 关卡数据容器
  + 标题页面
    - 帮助页面
    - 关卡选择页面
    - 关卡选单
    - 标题页面
    - 标题页背景动画
  + 存档
  + 音效
* GPU端代码
  + 数据格式定义
  + 顶点着色器
    - 从3D空间变换到相机空间的顶点着色器
  + 几何着色器
    - 用于对三角形计算法线并将法线数据附加到三角形的几何着色器
  + 像素着色器
    - 用于将表面涂为某种颜色的像素着色器
    - 用于对表面进行光照的像素着色器
    - 用于将表面涂为黑色的像素着色器
    - 用于对2D精灵进行上色的像素着色器
    - 用于显示标题页背景动画的像素着色器
* 开发工具
  + 资源构造器
  + 副本清理器
  + 命令行快速入口
  + 游戏快速入口
  + 游戏打包工具

## 四、代码结构

#### C++代码部分
游戏的主体部分
* Engine *对FunCode引擎的增强部分*
  + Rendering *对FunCode图形显示部分增补的3D和2D能力*
    - ObjLoader *3D模型加载器*
    - ObjModel *将3D模型作为游戏对象的容器*
    - PostEffect *后处理效果器*
    - Shaders *着色器加载器*
    - Sprite2D *2D精灵*
    - Tex2D *2D纹理*
    - VertexIn *用于将3D模型载入至显存的工具*
  + Assets *对FunCode增强的资源加载器*
  + Button *按钮精灵*
  + Cursor *鼠标样式*
  + Device *引擎增强管理器，用于集中管理对FunCode的增强部分和显存资源、GPU资源*
  + GameObject *游戏对象，用于抽象地表示一切游戏内的可以与玩家产生交互的对象*
  + Magic *FunCode增强器*
  + Math *数学工具*
  + ObjectSet *游戏对象集合，是一种游戏对象，可以使游戏对象组织为树结构*
  + Optional *对C\+\+14增补C\+\+17的std::optional*
  + OverwriteArray *复写表数据结构*
  + TaskList *延迟任务表，用于执行延迟一段时间的任务*
  + Tween *补帧器，用于对其管理的代数类型进行补帧，用于制作补帧动画*
* Game *游戏逻辑部分*
  + EngineTests *FunCode引擎增强部分测试，开发初期用于单元测试的组件，游戏中不使用此组件，此组件仅用于测试*
    - DemoCube *立方体Demo，显示一个3D的立方体模型*
    - DemoRotatingCube *旋转立方体Demo，显示一个旋转中的3D立方体模型*
    - ModelTest *复杂模型Demo，显示一个复杂的3D模型*
  + GamePlay *游戏玩法相关*
    - AnswerBoard *答案板，此对象显示游戏中谜题的解答*
    - Clock *表，用于显示游戏中的时间信息*
    - GameMain *主游戏场景，此对象传入关卡数据，并且调用其他对象来执行这个关卡*
    - RotatingCube *旋转中的魔方，用于显示谜题的3D解答部分，玩家操作此立方体来解谜*
    - StageComplete *关卡完成后显示的Finish对话框*
    - StageData *关卡数据容器，用于加载和存放关卡数据*
  + Title *标题页面部分*
    - Help *帮助页面*
    - StageSelectGUI *关卡选择界面*
    - StageSelectMenu *可以选择的关卡列表*
    - TitleGUI *标题页面*
  + MainBackground *背景动画*
  + SaveData *游戏存档*
  + SoundEffect *音效管理器*
  + Main *程序入口点，并且初始化FunCode引擎、FunCode增强和游戏逻辑*
* Globals *全局工具，包括日志记录器、鼠标光标开关和断言器*

#### HLSL代码部分
游戏需要在GPU上执行的图形相关的部分
* GSNormalCalc *计算输入给GPU的三角形的法线，并将法线信息附加到三角形上的几何着色器*
* PSColorOnly *对三角形统一涂色为单一颜色的像素着色器*
* PSCubeModel *根据三角形法线、灯光参数和观察者位置，对三角形进行光照计算的像素着色器*
* PSModelBlack *将三角形统一涂为黑色的像素着色器*
* PSSprite2DDefault *将三角形视为2D图形，根据给定图片进行上色的像素着色器*
* PSTitleBackground *用于显示标题页3D背景动画的像素着色器*
* VertexOut *定义GPU的数据格式*
* VSDefaultWVP *将3D三角形变换到2D空间的顶点着色器*

#### 脚本
开发游戏时使用的工具
* buildsst *将图片资源转换为sst格式，并将游戏资源复制到游戏目录*
* cleansst *清理所有资源副本，只保留原本的资源*
* command *快速启动控制台，并且将工作目录定到游戏工程目录*
* game *快速启动已经编译好的游戏*
* release *对游戏执行全部的构建操作，并且打包为zip文件*

## 五、关键技术点

### 在C\+\+14上实现C\+\+17特性

#### Optional数据结构
在开发中我们需要用到Optional数据结构，用于保存“可能存在”的对象，因此使用模板元编程在C++14上实现了C++17标准中的Optional结构。

### 对FunCode引擎的增强
由于对FunCode引擎进行了增强，所以不能使用FunCode的场景编辑器编辑游戏场景。

#### 对FunCode引擎的图形能力增强
对FunCode增补了3D图形的渲染能力，并且可以使其访问GPU的运算资源、加载3D模型，可以运行顶点着色器、几何着色器、像素着色器，并使其具备图形后处理能力。

#### 对FunCode的代码组织能力进行了增强
使用ECS架构重新组织了游戏中对游戏对象的处理方式，对游戏逻辑进行抽象。
且提供了对象集，使得游戏对象可以以树结构进行组织为场景树。

#### 延迟任务表
此数据结构为引擎增强部分的辅助工具，可以添加任务，使其延迟一段时间后再执行。

#### 补帧器
此数据类型为模板类型，可以对基本数据类型进行补帧操作，并且使用缓动函数。

### 游戏中使用的计算机图形学算法

#### 光线步进(RayMarching)算法
此算法用于在游戏的标题界面通过后处理效果来生成3D场景。   
它在像素着色器“PSTitleBackground”中被实现。   

算法思路：    
1. 此算法从像素点开始向屏幕透过的空间内投射一条光线，并且按照一定距离不断向前步进，直到该光线打击到一个几何体。
2. 光线打击到几何体后，从像素点再次发射光线，计算打击点周围的打击点坐标，得出主打击点的法线向量。
3. 根据法线向量、打击点位置和光源位置计算此点的Lambert光照和BlinPhong光照。
4. 从打击点向光源发射光线，来判断此打击点是否处在阴影之内。
5. 对光照强度和阴影强度进行混合，得到最终颜色。

#### 兰伯特(Lambert)光照模型
此算法用于计算光源在几何体上的漫反射光照，是一种双向反射分布函数。

该公式为   
Diffuse(I,theta) = Max(0,I\*cos(theta))   
这里y为反射光的强度，I为入射光的强度，theta为入射光与法线的角度。   
设入射光为L，法线为N，则有   
Diffuse(I,N,L) = Max(0,I\*(N・L))    
于是得到了使用入射光强、入射光向量、法线向量为自变量的Lambert函数：   
Diffuse(I,N,L) = Max(0,I\*(N・L))    

此算法在像素着色器“PSCubeModel”中实现。    

#### 比林・冯氏(Blinn-Phong)光照模型
此算法用于计算光源在几何体上的高光光照，是一种双向反射分布函数。

该公式为
Specular(N,H,S) = Max((N・H)^S,0)   
其中N为法线向量，H为入射光方向L与视点方向V的半角向量，S为高光系数。     
根据以上定义，我们可以得出以下结论：    
H = (L+V) / |L+V|
于是得到了使用法线向量、入射光向量、视点向量、高光系数为自变量的Blinn-Phong函数：   
Specular(N,L,V,S) = Max[(N・((L+V) / |L+V|)) ^ S,0]    

此算法在像素着色器“PSCubeModel”中实现。    

#### 双切线法线算法
为了计算光照，我们需要得到每个面的法线向量。   
该算法用于对每个三角形计算法线向量。   

该算法在渲染阶段中从顶点着色器装配三角形，并且计算出三角形的两条切线，并通过切线向量叉乘得到其法线向量。
设三角形三个点为p1,p2,p3，则得到两条切线向量：   
T1 = (p3 - p1) / |p3 - p1|   
T2 = (p3 - p2) / |p3 - p2|   

最终通过这两个切线向量得到法线向量：   
N\' = T1 x T2    

由于此时我们需要的法线向量必须为指向三角形背面，因此我们最终得到的N为：   
N = -N\'

最终得到的公式为：    
N = - [(p3 - p1) / |p3 - p1|] x [(p3 - p2) / |p3 - p2|]

此算法在几何着色器“GSNormalCalc”中实现。

#### 空间变换算法
为了能够使3D空间能够被操作，我们使用线性代数中的矩阵来变换3D图形，这个变换完全在GPU上执行。    
对3D空间的变换需要在三个层次上进行处理：    
1. 点从模型空间变换到世界空间的变换，我们可以调整这个矩阵来移动这个3D点在世界空间上的位置，称为W矩阵。
2. 点从世界空间到相机空间的变换，我们可以调整这个矩阵来移动相机的摆放位置和方向，成为V矩阵。
3. 点从相机空间到CVV空间的变换，我们可以调整这个矩阵来选择近大远小的透视投影或者无视Z轴的正交投影，成为P矩阵，该矩阵变换结束后，该点的W轴将会被GPU执行硬件除法进行投影。
最后对这三个矩阵进行相乘得到WVP矩阵：   
WVP = W x V x P   

对任何一个在单一模型中的点，计算其在CVV上的坐标，则可以使用以下公式：  
Pcvv = Pmodel x WVP
将Pcvv提交给GPU之后，剩下的变换操作将由GPU硬件完成，实现3D图形的绘制。


### 游戏中使用的其他算法

#### 补帧动画所使用的曲线
在游戏中为了实现效果更好的补帧动画，使用了以下这些函数来进行变换：
* f1(x) = -x^2 + 2*x
* f2(x) = sqrt[f1(x)]
* f3(x) = 1 - f2(x)
* f4(x) = 1 - f(x)
* f5(x) = sin(PI/2\*x)


#### 旋转时对惯性的模拟
在松开鼠标时计算256帧的速度，并且对其进行取平均值，得出惯性的初速度，然后对旋转立方体施加此速度。
之后将这个速度进行衰减，直到衰减为0。

## 六、完成时间进度情况
2018.4.1 项目开始    
2018.5.10 FunCode引擎加强完成    
2018.8.1 游戏逻辑编写完成    
2018.9.4 文档编写完成    

## 七、参考他人作品
未参考他人作品，完全原创。

## 八、小组成员以及分工

### 于静
山东职业学院教师，在此项目中担任指导教师。

### 许超
山东职业学院 软件定向1632班学生，在此项目中担任游戏策划、关卡设计和主程序。

### 郑家鹏
山东职业学院 软件定向1632班学生，在此项目中担任美术设计和程序，同时负责对FunCode引擎的分析和增强。

